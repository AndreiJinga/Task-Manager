@{
    ViewData["Title"] = "Task Manager";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

<div class="container mt-4">
    <div class="d-flex">
        <!-- LEFT: Flyere 80% -->
        <div class="me-3" style="flex: 0 0 80%;">
            <div class="row" id="flyerContainer">
                <!-- Flyere populate via JS -->
            </div>
        </div>

        <!-- RIGHT: Admin Panel 20% -->
        <div style="flex: 0 0 20%;">
            <div class="card p-3">
                <h5>Admin Panel</h5>

                <!-- Dropdown utilizatori -->
                <div id="mainAdminPanel">
                    <label for="adminUserSelect" class="form-label">Selectează utilizator:</label>
                    <select id="adminUserSelect" class="form-select mb-3">
                        <option value="">-- Alege utilizator --</option>
                    </select>

                    <div class="d-flex flex-column">
                        <button class="btn btn-primary mb-1 admin-mode-btn" data-mode="add">Adaugă task</button>
                        <button class="btn btn-warning mb-1 admin-mode-btn" data-mode="modify">Modifică status task</button>
                        <button class="btn btn-danger mb-1 admin-mode-btn" data-mode="delete">Șterge task</button>
                    </div>
                </div>

                <!-- Subpanel task -->
                <div id="adminSubPanel" style="display:none;">
                    <button id="backToMain" class="btn btn-secondary mb-2">⬅ Mergi înapoi</button>

                    <!-- Add Task -->
                    <div id="subpanelAdd" class="admin-subpanel" style="display:none;">
                        <input type="text" id="newTaskTitleSub" class="form-control mb-2" placeholder="Titlu task nou">
                        <button id="saveNewTaskBtn" class="btn btn-success w-100">Salvează task</button>
                    </div>

                    <!-- Modify Task -->
                    <div id="subpanelModify" class="admin-subpanel" style="display:none;">
                        <select id="taskSelectModify" class="form-select mb-2">
                            <option value="">-- Selectează task --</option>
                        </select>
                        <select id="taskStatusModify" class="form-select mb-2">
                            <option value="NotStarted">❌ Not started</option>
                            <option value="InProgress">⏳ In progress</option>
                            <option value="Completed">✅ Completed</option>
                        </select>
                        <button id="saveModifyTaskBtn" class="btn btn-warning w-100">Salvează modificare</button>
                    </div>

                    <!-- Delete Task -->
                    <div id="subpanelDelete" class="admin-subpanel" style="display:none;">
                        <select id="taskSelectDelete" class="form-select mb-2">
                            <option value="">-- Selectează task --</option>
                        </select>
                        <button id="saveDeleteTaskBtn" class="btn btn-danger w-100">Șterge task</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pentru adăugare user -->
<div class="modal fade" id="addFlyerModal" tabindex="-1" aria-labelledby="addFlyerLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addFlyerLabel">Introdu numele utilizatorului</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="newUserName" class="form-control" placeholder="Nume utilizator">
            </div>
            <div class="modal-footer">
                <button type="button" id="saveFlyer" class="btn btn-primary">Adaugă Flyer</button>
            </div>
        </div>
    </div>
</div>

<style>
    .sticky-note {
        background-color: #fff176;
        border-radius: 8px;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        min-height: 150px;
        margin-bottom: 15px;
    }

        .sticky-note ul li {
            margin-bottom: 5px;
        }
</style>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function(){

            // --- UTILITIES ---
            function getStatusIcon(status){
                switch(status){
                    case 'NotStarted': return '❌';
                    case 'InProgress': return '⏳';
                    case 'Completed': return '✅';
                    default: return '';
                }
            }

            // --- LOAD USERS & FLYERS ---
            function loadUsersAndFlyers(){
                $.get('/api/Users/GetAll', function(users){
                    const adminSelect = $('#adminUserSelect');
                    adminSelect.empty().append('<option value="">-- Alege utilizator --</option>');

                    const flyerContainer = $('#flyerContainer');
                    flyerContainer.empty();

                    users.forEach(u => {
                        // dropdown
                        adminSelect.append(`<option value="${u.Id}">${u.Name}</option>`);

                        // flyer
                        let tasksHtml = '';
                        u.Tasks.forEach(t => tasksHtml += `<li data-taskid="${t.Id}">${getStatusIcon(t.Status)} ${t.Title}</li>`);

                        flyerContainer.append(`
                            <div class="col-md-4">
                                <div class="sticky-note p-3" data-userid="${u.Id}">
                                    <div class="d-flex justify-content-between"><strong>${u.Name}</strong></div>
                                    <ul class="mt-2 list-unstyled">${tasksHtml}</ul>
                                </div>
                            </div>
                        `);
                    });

                    // Flyer "+"
                    flyerContainer.append(`
                        <div class="col-md-4">
                            <div class="sticky-note p-3 d-flex justify-content-center align-items-center add-flyer-note" style="height:150px; cursor:pointer;">
                                <h2>+</h2>
                            </div>
                        </div>
                    `);
                });
            }

            loadUsersAndFlyers();

            // --- ADMIN PANEL LOGIC ---
            $('.admin-mode-btn').click(function(){
                const mode = $(this).data('mode');
                $('#mainAdminPanel').hide();
                $('#adminSubPanel').show();
                $('.admin-subpanel').hide();

                if(mode==='add') $('#subpanelAdd').show();
                if(mode==='modify') $('#subpanelModify').show();
                if(mode==='delete') $('#subpanelDelete').show();

                populateTasksDropdowns();
            });

            $('#backToMain').click(function(){
                $('#adminSubPanel').hide();
                $('#mainAdminPanel').show();
            });

            $('#adminUserSelect').change(function(){
                populateTasksDropdowns();
            });

            function populateTasksDropdowns(){
                const userId = $('#adminUserSelect').val();
                if(!userId) return;

                $.get(`/api/Tasks/GetByUser?userId=${userId}`, function(tasks){
                    const modify = $('#taskSelectModify');
                    const del = $('#taskSelectDelete');

                    modify.empty().append('<option value="">-- Selectează task --</option>');
                    del.empty().append('<option value="">-- Selectează task --</option>');

                    tasks.forEach(t => {
                        modify.append(`<option value="${t.Id}">${t.Title}</option>`);
                        del.append(`<option value="${t.Id}">${t.Title}</option>`);
                    });
                });
            }

            // --- CRUD TASKS ---
            $('#saveNewTaskBtn').click(function(){
                const userId = $('#adminUserSelect').val();
                const title = $('#newTaskTitleSub').val().trim();
                if(!userId || !title) { alert('Selectează utilizator și introdu titlu!'); return; }

                $.ajax({
                    url: '/api/Tasks/Create',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ UserId: userId, Title: title }),
                    success: function(){ loadUsersAndFlyers(); populateTasksDropdowns(); $('#newTaskTitleSub').val(''); }
                });
            });

            $('#saveModifyTaskBtn').click(function(){
                const taskId = $('#taskSelectModify').val();
                const status = $('#taskStatusModify').val();
                if(!taskId) { alert('Selectează task!'); return; }

                $.ajax({
                    url: `/api/Tasks/UpdateStatus?taskId=${taskId}&status=${status}`,
                    method: 'POST',
                    success: function(){ loadUsersAndFlyers(); populateTasksDropdowns(); }
                });
            });

            $('#saveDeleteTaskBtn').click(function(){
                const taskId = $('#taskSelectDelete').val();
                if(!taskId) { alert('Selectează task!'); return; }

                $.ajax({
                    url: `/api/Tasks/Delete?taskId=${taskId}`,
                    method: 'POST',
                    success: function(){ loadUsersAndFlyers(); populateTasksDropdowns(); }
                });
            });

            // --- ADD FLYER HANDLER ---
            $(document).on('click', '.add-flyer-note', function(){
                $('#newUserName').val('');
                new bootstrap.Modal(document.getElementById('addFlyerModal')).show();
            });

            // Save Flyer
            $('#saveFlyer').click(function() {
                const name = $('#newUserName').val().trim();
                if(!name){ alert('Te rog introdu un nume.'); return; }

                $.ajax({
                    url: '/api/Users/Create',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ Name: name }),
                    success: function(){
                        loadUsersAndFlyers();
                    }
                });

                $('#addFlyerModal').modal('hide');
            });

        });
    </script>
}
